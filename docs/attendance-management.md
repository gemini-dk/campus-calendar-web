# 出欠管理仕様

## データモデル
- **出欠ステータス (`AttendanceStatus`)**: `present=1`（出席）、`absent=0`（欠席）、`late=2`（遅刻）を整数で保持します。画面ではステータス名とステータス別の色（出席=緑、欠席=赤、遅刻=黄）を用います。
- **授業 (`TimetableClass`)**: 授業ごとに授業回数に対応する日付一覧を持ち、`maxAbsenceDays` として最大欠席可能日数を保存します。完全オンデマンド授業を示す `omitWeeklySlots` や時間割のスコープなども合わせて管理されます。
- **授業日 (`TimetableClassDate`)**: 各授業回の出欠状態、試験フラグ、集計対象外フラグ（補講・試験など）、配信形態（対面/オンライン/未定）、自動生成フラグ、休講フラグを保持します。出欠集計の対象日かどうかは `isExcludedFromSummary` で判定します。

## 授業登録・編集時の設定
- 授業日を自動生成または手動で編集すると、集計対象 (`isExcludedFromSummary = false`) の件数を再計算し、最大欠席可能日数 `maxAbsenceDays` を更新します。
  - 完全オンデマンド（`isOnDemandOnly`）の場合は最大欠席可能日数を強制的に 0 に設定します。
  - それ以外では「集計対象の授業回数 × 0.33」を切り捨てた値を基本とし、授業回数を超えないように上限をかけます。
- 最大欠席可能日数は設定画面でステッパーから 0〜集計対象回数の範囲で調整できます。集計対象回数の変更に合わせて上下限が自動的に更新されます。

## 集計ロジック
- 出欠サマリーは授業詳細取得時に `isExcludedFromSummary = false` の授業日のみを対象とします。
- 各授業について以下を計算します。
  - **出席数 (`presentCount`)**: 出席ステータスの回数。
  - **欠席数 (`absentCount`)**: 欠席ステータスの回数。
  - **遅刻数 (`lateCount`)**: 遅刻ステータスの回数。
  - **未記入数 (`unrecordedCount`)**: 出欠未入力（ステータスが空）かつ当日以前の授業日の件数。未来日の未入力は集計しません。
  - **授業回数 (`totalCount`)**: 集計対象と判断された授業日の総数。
  - **最大欠席可能日数 (`maxAbsenceDays`)**: 授業マスタに保存された値をそのまま利用します。

## 表示仕様
- `AttendanceProgressView` では上記サマリーを可視化し、「出席数/授業回数」をメイン指標とします。
  - 出席数・遅刻数・未記入数を積み上げバーとして表示し、欠席数は右端から赤色で塗り分けます。
  - 最大欠席可能日数が設定されている場合は許容欠席割合に対応する位置へ黒いしきい値マーカーを表示します。
  - ラベルには「出席数/授業回数（遅刻・未記入の内訳付き）」と、「欠席数/最大欠席可能日数」を示します。
  - 残り欠席可能日数が 0 の場合は警告メッセージを表示し、超過時は注意メッセージに切り替えます。
- 授業カードや詳細画面では、このサマリーと個別授業日の出欠ボタンを組み合わせ、遅刻・欠席・出席のいずれかを即時更新できるようにしています。
