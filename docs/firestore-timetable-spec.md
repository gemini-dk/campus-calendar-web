# Web版CampusCalendar Firestore仕様（授業作成・時間割）

本書は iOS 版で SQLite を利用していた授業作成・時間割機能を、Firestore の `/users/{uid}` 配下に移植するための設計をまとめます。全体的なデータモデルは「Firestoreデータモデル設計（SQLite移行版）」を前提とし、本書では授業（`timetable_classes`）とその周辺データにフォーカスします。

## コレクションツリー

```
/users/{uid}
  /academic_years/{fiscalYear}
      ...年度設定...
      /timetable_classes/{classId}
          <授業本体フィールド>
          /weekly_slots/{slotId}
              dayOfWeek, period, displayOrder
      /class_dates/{classDateId}
          classId, classDate, periods, attendanceStatus, ...
```

- 各ユーザーは年度ごとに授業を保持します。年度ドキュメントは `academic_year_settings` の移植先に相当します。
- 授業ドキュメントは SQLite の `timetable_classes` レコードを 1:1 で移行し、週次枠 (`timetable_weekly_slots`) はサブコレクションとして保持します。授業日 (`timetable_class_dates`) は年度直下の `class_dates` コレクションに集約し、各ドキュメントに `classId` を保持します。

## 授業ドキュメント仕様

### `/users/{uid}/academic_years/{fiscalYear}/timetable_classes/{classId}`

| フィールド | 型 | 説明 |
| --- | --- | --- |
| `className` | string | 必須。前後空白トリム。 |
| `fiscalYear` | number | 親ドキュメントの年度と一致。クエリ用に冗長保持。 |
| `calendarId` | string | 紐づく学務カレンダー ID。 |
| `termNames` | array<string> | UI 選択順を保持。重複排除。 |
| `termDisplayName` | string|null | 表示用（`,` 結合）。 |
| `classType` | enum string (`in_person`/`online`/`hybrid`/`on_demand`) | 実施形態。 |
| `credits` | number|null | 単位数。 |
| `creditsStatus` | enum string (`in_progress`/`completed`/`failed`) | 取得状況。 |
| `teacher` | string|null | 教員名。 |
| `location` | string|null | 教室。ハイブリッド授業の場合は未使用。 |
| `locationInPerson` | string|null | ハイブリッド授業の対面場所。 |
| `locationOnline` | string|null | ハイブリッド授業のオンライン場所（URL 等）。 |
| `memo` | string|null | 任意メモ。 |
| `isFullyOnDemand` | boolean | 完全オンデマンド授業。 |
| `maxAbsenceDays` | number | 欠席許容上限。 |
| `createdAt` / `updatedAt` | timestamp | Firestore サーバタイムスタンプ。 |

### `weekly_slots` サブコレクション

- パス: `/users/{uid}/academic_years/{fiscalYear}/timetable_classes/{classId}/weekly_slots/{slotId}`
- フィールド: `dayOfWeek`(1=Mon〜7=Sun), `period`(1〜N, 0=オンデマンド), `displayOrder`(number), `createdAt`, `updatedAt`。
- 週次枠は授業作成 UI のフォームから登録し、曜日＋時限の組み合わせで一意制約をかける（クライアントバリデーション + ルール）。

### `class_dates` コレクション

- パス: `/users/{uid}/academic_years/{fiscalYear}/class_dates/{classDateId}`
- おすすめドキュメント ID: `classId#YYYY-MM-DD` もしくは `classId#YYYY-MM-DD#slotHash`（複数枠対応）。
- フィールド:
  | フィールド | 型 | 説明 |
  | --- | --- | --- |
  | `classId` | string | 親授業ドキュメントの ID。 |
  | `classDate` | string (ISO 日付) | 集計・ソート用。 |
  | `periods` | array<number|string> | 対象コマ。オンデマンドは `"OD"` を推奨。 |
  | `attendanceStatus` | enum (`present`/`absent`/`late`/`null`) | 出欠結果。 |
  | `isTest` | boolean | 試験回。 |
  | `isExcludedFromSummary` | boolean | 集計対象外。 |
  | `isAutoGenerated` | boolean | 自動生成フラグ。 |
  | `isCancelled` | boolean | 休講フラグ。 |
  | `deliveryType` | enum (`unknown`/`in_person`/`remote`) | 実施形態。 |
  | `hasUserModifications` | boolean | 手動編集済み。 |
  | `periodsOrderKey` | number | 並べ替え用（例: 最小 period、オンデマンドは 999）。 |
  | `updatedAt` | timestamp | Firestore サーバタイムスタンプ。 |

## 授業自動生成フロー

1. **入力の検証**  
   - UI で選択した曜日・時限セットが空の場合、`isFullyOnDemand` を `true` に設定し `maxAbsenceDays = 0` に固定します。  
   - オンデマンド以外では少なくとも 1 件の週次枠が必要です。
2. **日付展開**  
   - Convex 由来の学務カレンダーデータを `/users/{uid}/calendars/{calendarId}/days` から取得し、`type` が授業日に該当する日付を抽出します。  
   - 抽出した日付に対し、週次枠の曜日一致と学期フィルタを適用して `class_dates` 用の候補リストを構築します。
3. **ドキュメント生成**  
   - 候補リストを `classDate` × `periods` でグループ化し、既存 `class_dates` と照合。  
   - `isAutoGenerated == true` かつ `hasUserModifications == false` のレコードのみ上書き。ユーザー編集済みは保持します。
4. **欠席許容回数の計算**  
   - `isExcludedFromSummary == false` かつ `isCancelled == false` の件数を `count` とし、`floor(count * 0.33)` を上限 `count` でクリップして `maxAbsenceDays` に保存。  
   - `isFullyOnDemand == true` の場合は常に 0。
5. **バッチ書き込み**
   - 授業本体と関連コレクション（`weekly_slots`・`class_dates`）の更新はバッチまたはトランザクションで実行し、中途半端な状態を避けます。

## 日程編集・出欠更新

- ユーザーが日程を編集した場合は、対象 `class_dates` の `hasUserModifications` を `true` にセットし、自動生成処理では上書きしません。
- 休講設定時は `isCancelled = true`、`attendanceStatus = null` に戻します。
- 出欠変更はクライアントで即時反映しつつ、Cloud Functions で `maxAbsenceDays` 超過を監査して警告を発行する運用を推奨します。

## セキュリティルールとバリデーション

- ルール例:
  ```
  match /users/{uid}/academic_years/{year}/timetable_classes/{classId} {
    allow read, write: if request.auth.uid == uid;
    allow update: if request.resource.data.className is string
                  && request.resource.data.className.size() > 0;
  }
  ```
- `weekly_slots` 書き込みでは `dayOfWeek` が `1..7`、`period >= 0` をチェックします。
- `class_dates` 書き込みでは Future 日付を許可するかどうかをルールで制御できます（必要に応じて Cloud Functions で補完）。

## インデックス指針

| コレクション | クエリ | 推奨インデックス |
| --- | --- | --- |
| `timetable_classes` | 学期別フィルタ + 名称昇順 | `termNames ARRAY_CONTAINS`, `className ASC` |
| `class_dates` | `classId == ...` かつ `isExcludedFromSummary == false` で `classDate ASC` | 複合インデックス (`classId`, `isExcludedFromSummary`, `classDate`) |
| `class_dates` | `classId == ...` かつ `attendanceStatus == null` で `classDate <= today` | (`classId`, `attendanceStatus`, `classDate`) |

## マイグレーション手順

1. SQLite から `timetable_classes`, `timetable_weekly_slots`, `timetable_class_dates` を抽出。
2. ユーザー UID ごとに年度別でまとめ、Firestore バッチに投入。
3. `class_dates` 生成時に `attendanceStatus` の整数値を enum 文字列へマッピング（`1 -> present`, `0 -> absent`, `2 -> late` など）。
4. 書き込み完了後に Cloud Functions を呼び出し、`maxAbsenceDays` の再計算や履修状況確認を実行。

## 関連ドキュメント

- `docs/schema.md`（Firestore 全体構造）
- `docs/attendance-management.md`（出欠集計仕様）
- `docs/calendar_display_logic.md`（学務カレンダー表示ロジック）

以上により、SQLite 時代と同等の授業管理機能を Firestore 上で構築しつつ、ユーザー単位でのデータ分離とリアルタイム更新に対応できます。
